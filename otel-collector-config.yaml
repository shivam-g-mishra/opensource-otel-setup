# =============================================================================
# OpenTelemetry Collector Configuration
# =============================================================================
# Production-ready setup with reliability features:
#   - Persistent queues (survives restarts)
#   - Enhanced retry policies with exponential backoff
#   - Memory limiting to prevent OOM
#   - Connection keep-alive
#
# Endpoints for your application:
#   - OTLP gRPC: localhost:4317 (recommended for high throughput)
#   - OTLP HTTP: localhost:4318 (for browsers/environments without gRPC)
#
# =============================================================================

# -----------------------------------------------------------------------------
# RECEIVERS - How data enters the collector
# -----------------------------------------------------------------------------
receivers:
  # OTLP receiver - the standard OpenTelemetry protocol
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
        max_recv_msg_size_mib: 4
        keepalive:
          server_parameters:
            time: 30s
            timeout: 10s
      http:
        endpoint: 0.0.0.0:4318
        # CORS configuration - restrict for production!
        cors:
          allowed_origins:
            - "http://*"
            - "https://*"
          allowed_headers:
            - "*"
          # Production example:
          # allowed_origins:
          #   - "https://myapp.example.com"

  # Self-monitoring - collector's own metrics
  prometheus:
    config:
      scrape_configs:
        - job_name: 'otel-collector-self'
          scrape_interval: 10s
          static_configs:
            - targets: ['localhost:8888']

# -----------------------------------------------------------------------------
# PROCESSORS - Transform and enrich data
# -----------------------------------------------------------------------------
processors:
  # Memory limiter - CRITICAL: Prevents OOM crashes
  # Set to 80% of container memory limit (2GB -> 1600MiB)
  memory_limiter:
    check_interval: 1s
    limit_mib: 1600
    spike_limit_mib: 400

  # Batch processor - Improves performance by batching requests
  batch:
    timeout: 5s
    send_batch_size: 1024
    send_batch_max_size: 2048

  # Resource processor - Add/modify resource attributes
  resource:
    attributes:
      - key: service.namespace
        value: ${SERVICE_NAMESPACE:-default}
        action: upsert
      - key: deployment.environment
        value: ${DEPLOYMENT_ENV:-development}
        action: upsert

  # Attributes processor - Add custom attributes to spans/metrics
  attributes:
    actions:
      - key: collector.name
        value: otel-collector
        action: insert
      - key: collector.version
        value: "0.91.0"
        action: insert

# -----------------------------------------------------------------------------
# EXPORTERS - Where data goes
# -----------------------------------------------------------------------------
exporters:
  # Jaeger exporter - for distributed traces
  otlp/jaeger:
    endpoint: jaeger:4317
    tls:
      insecure: true
    timeout: 30s
    retry_on_failure:
      enabled: true
      initial_interval: 1s
      randomization_factor: 0.5
      multiplier: 2
      max_interval: 60s
      max_elapsed_time: 300s
    sending_queue:
      enabled: true
      num_consumers: 10
      queue_size: 10000
      storage: file_storage
    keepalive:
      time: 30s
      timeout: 10s
      permit_without_stream: true

  # Prometheus exporter - for metrics (pull-based, no queue needed)
  prometheus:
    endpoint: "0.0.0.0:8889"
    namespace: app
    const_labels:
      collector: otel
    resource_to_telemetry_conversion:
      enabled: true

  # Loki exporter - for logs
  loki:
    endpoint: http://loki:3100/loki/api/v1/push
    tls:
      insecure: true
    timeout: 30s
    default_labels_enabled:
      exporter: true
      job: true
    retry_on_failure:
      enabled: true
      initial_interval: 1s
      randomization_factor: 0.5
      multiplier: 2
      max_interval: 60s
      max_elapsed_time: 300s
    sending_queue:
      enabled: true
      num_consumers: 10
      queue_size: 10000
      storage: file_storage

  # Debug logging - useful for troubleshooting
  debug:
    verbosity: basic
    sampling_initial: 2
    sampling_thereafter: 500

# -----------------------------------------------------------------------------
# EXTENSIONS - Additional capabilities
# -----------------------------------------------------------------------------
extensions:
  # Health check - for container orchestration
  health_check:
    endpoint: 0.0.0.0:13133
    path: /health
    tls:
      insecure: true

  # Performance profiling
  pprof:
    endpoint: 0.0.0.0:1888

  # ZPages - debugging UI
  zpages:
    endpoint: 0.0.0.0:55679

  # File storage - CRITICAL: Enables persistent queues
  # Data survives collector restarts
  file_storage:
    directory: /var/lib/otelcol/storage
    timeout: 10s
    compaction:
      on_start: true
      on_rebound: true
      directory: /var/lib/otelcol/storage/compaction

# -----------------------------------------------------------------------------
# SERVICE - Wire everything together
# -----------------------------------------------------------------------------
service:
  extensions: [health_check, pprof, zpages, file_storage]
  
  telemetry:
    logs:
      level: info
    metrics:
      level: detailed
      address: 0.0.0.0:8888

  pipelines:
    traces:
      receivers: [otlp]
      processors: [memory_limiter, batch, resource, attributes]
      exporters: [otlp/jaeger, debug]
    
    metrics:
      receivers: [otlp, prometheus]
      processors: [memory_limiter, batch, resource, attributes]
      exporters: [prometheus, debug]
    
    logs:
      receivers: [otlp]
      processors: [memory_limiter, batch, resource]
      exporters: [loki, debug]
