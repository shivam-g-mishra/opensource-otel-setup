# Kubernetes - Mimir Deployment
#
# Grafana Mimir - Horizontally scalable metrics backend
# 100% Prometheus-compatible, uses S3 for long-term storage
#
# Apply: kubectl apply -f mimir.yaml

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mimir-config
  namespace: observability
data:
  mimir.yaml: |
    target: all
    
    multitenancy_enabled: false
    
    server:
      http_listen_port: 9009
      grpc_listen_port: 9095
      log_level: info
      log_format: logfmt
    
    distributor:
      ring:
        kvstore:
          store: memberlist
      pool:
        health_check_ingesters: true
    
    ingester:
      ring:
        kvstore:
          store: memberlist
        replication_factor: 1
        heartbeat_period: 5s
        heartbeat_timeout: 1m
    
    ingester_client:
      grpc_client_config:
        max_recv_msg_size: 104857600
        max_send_msg_size: 104857600
    
    store_gateway:
      sharding_ring:
        kvstore:
          store: memberlist
        replication_factor: 1
    
    compactor:
      data_dir: /data/compactor
      sharding_ring:
        kvstore:
          store: memberlist
      compaction_interval: 30m
      deletion_delay: 2h
      cleanup_interval: 15m
    
    blocks_storage:
      backend: s3
      s3:
        bucket_name: mimir-blocks
        endpoint: minio.minio.svc.cluster.local:9000
        access_key_id: ${S3_ACCESS_KEY}
        secret_access_key: ${S3_SECRET_KEY}
        insecure: true
      bucket_store:
        sync_dir: /data/tsdb-sync
        bucket_index:
          enabled: true
      tsdb:
        dir: /data/tsdb
        block_ranges_period: [2h]
        retention_period: 744h
        ship_interval: 1m
        head_compaction_interval: 15m
    
    frontend:
      align_queries_with_step: true
      log_queries_longer_than: 10s
      parallelize_shardable_queries: true
      cache_results: true
      query_sharding_target_series_per_shard: 2500
    
    query_scheduler:
      max_outstanding_requests_per_tenant: 100
    
    querier:
      max_concurrent: 20
      timeout: 2m
      query_ingesters_within: 13h
    
    ruler:
      enable_api: true
      ring:
        kvstore:
          store: memberlist
      rule_path: /data/rules
    
    ruler_storage:
      backend: s3
      s3:
        bucket_name: mimir-ruler
        endpoint: minio.minio.svc.cluster.local:9000
        access_key_id: ${S3_ACCESS_KEY}
        secret_access_key: ${S3_SECRET_KEY}
        insecure: true
    
    alertmanager:
      data_dir: /data/alertmanager
      enable_api: true
      external_url: /alertmanager
    
    alertmanager_storage:
      backend: s3
      s3:
        bucket_name: mimir-alertmanager
        endpoint: minio.minio.svc.cluster.local:9000
        access_key_id: ${S3_ACCESS_KEY}
        secret_access_key: ${S3_SECRET_KEY}
        insecure: true
    
    memberlist:
      bind_port: 7946
      join_members:
        - mimir-headless.observability.svc.cluster.local:7946
    
    limits:
      ingestion_rate: 100000
      ingestion_burst_size: 200000
      max_global_series_per_user: 1500000
      max_global_series_per_metric: 50000
      max_label_names_per_series: 30
      max_fetched_series_per_query: 100000
      max_fetched_chunk_bytes_per_query: 2147483648
      max_query_parallelism: 32
      compactor_blocks_retention_period: 744h
      out_of_order_time_window: 30m
    
    activity_tracker:
      filepath: /data/activity.log
      max_entries: 1024

---
apiVersion: v1
kind: Secret
metadata:
  name: mimir-s3-credentials
  namespace: observability
type: Opaque
stringData:
  access-key: "minioadmin"
  secret-key: "minioadmin123"

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mimir
  namespace: observability
  labels:
    app: mimir
spec:
  serviceName: mimir-headless
  replicas: 1
  selector:
    matchLabels:
      app: mimir
  template:
    metadata:
      labels:
        app: mimir
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9009"
    spec:
      containers:
        - name: mimir
          image: grafana/mimir:2.11.0
          args:
            - "-config.file=/etc/mimir/mimir.yaml"
            - "-target=all"
          env:
            - name: S3_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: mimir-s3-credentials
                  key: access-key
            - name: S3_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: mimir-s3-credentials
                  key: secret-key
          ports:
            - name: http
              containerPort: 9009
              protocol: TCP
            - name: grpc
              containerPort: 9095
              protocol: TCP
            - name: memberlist
              containerPort: 7946
              protocol: TCP
          resources:
            requests:
              cpu: "500m"
              memory: "1Gi"
            limits:
              cpu: "2"
              memory: "4Gi"
          livenessProbe:
            httpGet:
              path: /ready
              port: 9009
            initialDelaySeconds: 45
            periodSeconds: 10
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /ready
              port: 9009
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
          volumeMounts:
            - name: config
              mountPath: /etc/mimir
            - name: data
              mountPath: /data
      volumes:
        - name: config
          configMap:
            name: mimir-config
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: standard
        resources:
          requests:
            storage: 50Gi

---
apiVersion: v1
kind: Service
metadata:
  name: mimir
  namespace: observability
  labels:
    app: mimir
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 9009
      targetPort: 9009
      protocol: TCP
    - name: grpc
      port: 9095
      targetPort: 9095
      protocol: TCP
  selector:
    app: mimir

---
apiVersion: v1
kind: Service
metadata:
  name: mimir-headless
  namespace: observability
  labels:
    app: mimir
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: memberlist
      port: 7946
      targetPort: 7946
      protocol: TCP
  selector:
    app: mimir
