# Kubernetes - Grafana HA Deployment
#
# Grafana - Visualization and dashboards
# Configured for HA with PostgreSQL backend for shared state
#
# Apply: kubectl apply -f grafana.yaml

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: observability
data:
  datasources.yaml: |
    apiVersion: 1
    
    deleteDatasources:
      - name: Prometheus
        orgId: 1
    
    datasources:
      - name: Mimir
        type: prometheus
        access: proxy
        url: http://mimir.observability.svc.cluster.local:9009/prometheus
        isDefault: true
        editable: false
        uid: mimir
        jsonData:
          timeInterval: "15s"
          httpMethod: POST
          manageAlerts: true
          prometheusType: Mimir
          exemplarTraceIdDestinations:
            - name: traceID
              datasourceUid: tempo
              urlDisplayLabel: "View Trace"
      
      - name: Tempo
        type: tempo
        access: proxy
        url: http://tempo.observability.svc.cluster.local:3200
        editable: false
        uid: tempo
        jsonData:
          httpMethod: GET
          tracesToLogsV2:
            datasourceUid: loki
            spanStartTimeShift: '-1h'
            spanEndTimeShift: '1h'
            filterByTraceID: true
            filterBySpanID: false
            customQuery: true
            query: '{$${__tags}} |= "$${__span.traceId}"'
          tracesToMetrics:
            datasourceUid: mimir
            spanStartTimeShift: '-1h'
            spanEndTimeShift: '1h'
            tags:
              - key: service.name
                value: service
              - key: service.namespace
                value: namespace
            queries:
              - name: Request Rate
                query: 'sum(rate(traces_spanmetrics_calls_total{$$__tags}[5m]))'
              - name: Error Rate
                query: 'sum(rate(traces_spanmetrics_calls_total{$$__tags, status_code="STATUS_CODE_ERROR"}[5m]))'
          serviceMap:
            datasourceUid: mimir
          nodeGraph:
            enabled: true
          lokiSearch:
            datasourceUid: loki
      
      - name: Loki
        type: loki
        access: proxy
        url: http://loki.observability.svc.cluster.local:3100
        editable: false
        uid: loki
        jsonData:
          timeout: 300
          maxLines: 1000
          derivedFields:
            - name: TraceID
              matcherRegex: '"trace_id":"?([a-fA-F0-9]+)"?'
              url: '$${__value.raw}'
              datasourceUid: tempo
              urlDisplayLabel: "View Trace"
      
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus.observability.svc.cluster.local:9090
        editable: false
        uid: prometheus
        jsonData:
          timeInterval: "15s"
          httpMethod: POST

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-provisioning
  namespace: observability
data:
  dashboards.yaml: |
    apiVersion: 1
    
    providers:
      - name: 'Observability Stack'
        orgId: 1
        folder: 'Observability'
        folderUid: 'observability'
        type: file
        disableDeletion: false
        updateIntervalSeconds: 30
        allowUiUpdates: true
        options:
          path: /var/lib/grafana/dashboards
          foldersFromFilesStructure: true

---
apiVersion: v1
kind: Secret
metadata:
  name: grafana-credentials
  namespace: observability
type: Opaque
stringData:
  admin-user: "admin"
  admin-password: "admin"  # CHANGE IN PRODUCTION

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: observability
  labels:
    app: grafana
spec:
  replicas: 2
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "3000"
    spec:
      securityContext:
        fsGroup: 472
        runAsGroup: 472
        runAsUser: 472
        runAsNonRoot: true
      containers:
        - name: grafana
          image: grafana/grafana:10.2.3
          env:
            - name: GF_SECURITY_ADMIN_USER
              valueFrom:
                secretKeyRef:
                  name: grafana-credentials
                  key: admin-user
            - name: GF_SECURITY_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: grafana-credentials
                  key: admin-password
            - name: GF_USERS_ALLOW_SIGN_UP
              value: "false"
            - name: GF_SERVER_ROOT_URL
              value: "http://grafana.example.com"
            - name: GF_FEATURE_TOGGLES_ENABLE
              value: "traceqlEditor tempoServiceGraph tempoSearch tempoBackendSearch"
            - name: GF_AUTH_ANONYMOUS_ENABLED
              value: "false"
            - name: GF_ALERTING_ENABLED
              value: "true"
            - name: GF_UNIFIED_ALERTING_ENABLED
              value: "true"
            # PostgreSQL for HA (use when deploying postgresql.yaml)
            # - name: GF_DATABASE_TYPE
            #   value: "postgres"
            # - name: GF_DATABASE_HOST
            #   value: "postgresql.observability.svc.cluster.local:5432"
            # - name: GF_DATABASE_NAME
            #   value: "grafana"
            # - name: GF_DATABASE_USER
            #   valueFrom:
            #     secretKeyRef:
            #       name: postgresql-credentials
            #       key: username
            # - name: GF_DATABASE_PASSWORD
            #   valueFrom:
            #     secretKeyRef:
            #       name: postgresql-credentials
            #       key: password
          ports:
            - name: http
              containerPort: 3000
              protocol: TCP
          resources:
            requests:
              cpu: "250m"
              memory: "512Mi"
            limits:
              cpu: "1"
              memory: "1Gi"
          livenessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 5
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: false
          volumeMounts:
            - name: datasources
              mountPath: /etc/grafana/provisioning/datasources
            - name: dashboards-provisioning
              mountPath: /etc/grafana/provisioning/dashboards
            - name: data
              mountPath: /var/lib/grafana
      volumes:
        - name: datasources
          configMap:
            name: grafana-datasources
        - name: dashboards-provisioning
          configMap:
            name: grafana-dashboards-provisioning
        - name: data
          emptyDir: {}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: grafana
                topologyKey: kubernetes.io/hostname

---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: observability
  labels:
    app: grafana
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 3000
      targetPort: 3000
      protocol: TCP
  selector:
    app: grafana

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana
  namespace: observability
  annotations:
    # Adjust annotations based on your ingress controller
    # nginx.ingress.kubernetes.io/rewrite-target: /
    kubernetes.io/ingress.class: nginx
spec:
  rules:
    - host: grafana.example.com  # Change to your domain
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: grafana
                port:
                  number: 3000

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: grafana-pdb
  namespace: observability
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: grafana
