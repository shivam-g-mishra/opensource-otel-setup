# HAProxy Configuration for OTel Collector Load Balancing
#
# Features:
# - gRPC and HTTP load balancing
# - Health check based routing
# - Connection pooling
# - Statistics dashboard
#
# Stats UI: http://localhost:8404/stats

global
    log stdout format raw local0
    maxconn 4096

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5s
    timeout client  60s
    timeout server  60s
    retries 3

# =============================================================================
# Statistics Dashboard
# =============================================================================
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST

# =============================================================================
# OTLP gRPC Frontend (port 4317)
# =============================================================================
frontend otel_grpc
    bind *:4317
    mode tcp
    option tcplog
    default_backend otel_gateways_grpc

backend otel_gateways_grpc
    mode tcp
    balance roundrobin
    option tcp-check
    
    # Health check on gRPC port
    # Note: In production, use gRPC health check
    server-template gateway 5 otel-gateway:4317 check inter 5s fall 3 rise 2

# =============================================================================
# OTLP HTTP Frontend (port 4318)
# =============================================================================
frontend otel_http
    bind *:4318
    mode http
    option httplog
    default_backend otel_gateways_http

backend otel_gateways_http
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    server-template gateway 5 otel-gateway:4318 check inter 5s fall 3 rise 2

# =============================================================================
# Grafana Frontend (optional)
# =============================================================================
frontend grafana
    bind *:3001
    mode http
    option httplog
    default_backend grafana_servers

backend grafana_servers
    mode http
    balance roundrobin
    option httpchk GET /api/health
    http-check expect status 200
    
    server grafana1 grafana:3000 check inter 10s fall 3 rise 2
