# Ansible Playbook for Observability Stack Deployment
#
# Deploys the OpenTelemetry observability stack using Docker Compose
#
# Usage:
#   # Single node deployment
#   ansible-playbook -i inventory playbook.yml
#
#   # Scalable deployment with Kafka
#   ansible-playbook -i inventory playbook.yml -e deployment_type=scalable
#
#   # Dry run
#   ansible-playbook -i inventory playbook.yml --check

---
- name: Deploy Observability Stack
  hosts: observability
  become: true
  vars:
    # Deployment configuration
    deployment_type: "{{ deployment_type | default('single') }}"
    install_dir: /opt/observability
    
    # Docker configuration
    docker_compose_version: "{{ docker_compose_version | default('2.23.0') }}"
    
    # Stack versions
    otel_collector_version: "{{ otel_collector_version | default('0.91.0') }}"
    grafana_version: "10.2.3"
    prometheus_version: "2.48.0"
    loki_version: "2.9.3"
    tempo_version: "2.3.0"
    mimir_version: "2.11.0"
    
    # Credentials
    grafana_admin_password: "{{ grafana_admin_password | default('admin') }}"
    
    # Retention settings
    prometheus_retention: "{{ prometheus_retention | default('7d') }}"
    
  tasks:
    # =========================================================================
    # Prerequisites
    # =========================================================================
    
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
    
    - name: Install required packages
      ansible.builtin.package:
        name:
          - curl
          - git
          - python3-pip
          - ca-certificates
          - gnupg
          - lsb-release
        state: present
    
    # =========================================================================
    # Docker Installation
    # =========================================================================
    
    - name: Check if Docker is installed
      ansible.builtin.command: docker --version
      register: docker_installed
      ignore_errors: true
      changed_when: false
    
    - name: Install Docker (Debian/Ubuntu)
      when: 
        - docker_installed.rc != 0
        - ansible_os_family == "Debian"
      block:
        - name: Create keyrings directory
          ansible.builtin.file:
            path: /etc/apt/keyrings
            state: directory
            mode: '0755'
        
        - name: Download Docker GPG key
          ansible.builtin.get_url:
            url: https://download.docker.com/linux/ubuntu/gpg
            dest: /etc/apt/keyrings/docker.asc
            mode: '0644'
        
        - name: Add Docker repository
          ansible.builtin.apt_repository:
            repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
            state: present
            filename: docker
        
        - name: Install Docker packages
          ansible.builtin.apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
            update_cache: true
    
    - name: Ensure Docker service is running
      ansible.builtin.service:
        name: docker
        state: started
        enabled: true
    
    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: true
    
    # =========================================================================
    # Directory Setup
    # =========================================================================
    
    - name: Create installation directory
      ansible.builtin.file:
        path: "{{ install_dir }}"
        state: directory
        mode: '0755'
    
    - name: Create subdirectories
      ansible.builtin.file:
        path: "{{ install_dir }}/{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - configs
        - data
        - logs
        - backups
        - grafana/provisioning/datasources
        - grafana/provisioning/dashboards
        - prometheus/rules
    
    # =========================================================================
    # Copy Configuration Files
    # =========================================================================
    
    - name: Copy Docker Compose file (single)
      ansible.builtin.copy:
        src: "../docker/docker-compose-single.yaml"
        dest: "{{ install_dir }}/docker-compose.yaml"
        mode: '0644'
      when: deployment_type == 'single'
    
    - name: Copy Docker Compose file (scalable)
      ansible.builtin.copy:
        src: "../docker/docker-compose-scalable.yaml"
        dest: "{{ install_dir }}/docker-compose.yaml"
        mode: '0644'
      when: deployment_type == 'scalable'
    
    - name: Copy OTel Collector config (single)
      ansible.builtin.copy:
        src: "../docker/otel-collector.yaml"
        dest: "{{ install_dir }}/otel-collector.yaml"
        mode: '0644'
      when: deployment_type == 'single'
    
    - name: Copy OTel Gateway config (scalable)
      ansible.builtin.copy:
        src: "../docker/otel-gateway.yaml"
        dest: "{{ install_dir }}/otel-gateway.yaml"
        mode: '0644'
      when: deployment_type == 'scalable'
    
    - name: Copy OTel Processor config (scalable)
      ansible.builtin.copy:
        src: "../docker/otel-processor.yaml"
        dest: "{{ install_dir }}/otel-processor.yaml"
        mode: '0644'
      when: deployment_type == 'scalable'
    
    - name: Copy HAProxy config (scalable)
      ansible.builtin.copy:
        src: "../docker/haproxy.cfg"
        dest: "{{ install_dir }}/haproxy.cfg"
        mode: '0644'
      when: deployment_type == 'scalable'
    
    - name: Copy storage backend configs (scalable)
      ansible.builtin.copy:
        src: "../docker/{{ item }}"
        dest: "{{ install_dir }}/{{ item }}"
        mode: '0644'
      loop:
        - tempo.yaml
        - mimir.yaml
        - mimir-runtime.yaml
        - loki.yaml
        - prometheus.yml
        - alertmanager-fallback.yaml
      when: deployment_type == 'scalable'
    
    - name: Copy Grafana datasources
      ansible.builtin.copy:
        src: "../docker/grafana/provisioning/datasources/datasources.yaml"
        dest: "{{ install_dir }}/grafana/provisioning/datasources/datasources.yaml"
        mode: '0644'
    
    - name: Copy Grafana dashboards config
      ansible.builtin.copy:
        src: "../docker/grafana/provisioning/dashboards/dashboards.yaml"
        dest: "{{ install_dir }}/grafana/provisioning/dashboards/dashboards.yaml"
        mode: '0644'
    
    - name: Copy Prometheus alerting rules (scalable)
      ansible.builtin.copy:
        src: "../docker/prometheus/rules/otel-stack-alerts.yml"
        dest: "{{ install_dir }}/prometheus/rules/otel-stack-alerts.yml"
        mode: '0644'
      when: deployment_type == 'scalable'
    
    # =========================================================================
    # Environment Configuration
    # =========================================================================
    
    - name: Create environment file
      ansible.builtin.template:
        src: templates/env.j2
        dest: "{{ install_dir }}/.env"
        mode: '0600'
    
    # =========================================================================
    # Deploy Stack
    # =========================================================================
    
    - name: Pull Docker images
      ansible.builtin.command: docker compose pull
      args:
        chdir: "{{ install_dir }}"
      register: pull_result
      changed_when: "'Pulled' in pull_result.stdout or 'Downloaded' in pull_result.stdout"
    
    - name: Start observability stack
      ansible.builtin.command: docker compose up -d
      args:
        chdir: "{{ install_dir }}"
      register: compose_result
      changed_when: "'Started' in compose_result.stdout or 'Created' in compose_result.stdout"
    
    # =========================================================================
    # Health Checks
    # =========================================================================
    
    - name: Wait for Grafana to be ready
      ansible.builtin.uri:
        url: "http://localhost:3000/api/health"
        status_code: 200
      register: grafana_health
      until: grafana_health.status == 200
      retries: 30
      delay: 10
    
    - name: Wait for Prometheus to be ready (scalable)
      ansible.builtin.uri:
        url: "http://localhost:9090/-/healthy"
        status_code: 200
      register: prometheus_health
      until: prometheus_health.status == 200
      retries: 20
      delay: 5
      when: deployment_type == 'scalable'
    
    # =========================================================================
    # Setup Systemd Service
    # =========================================================================
    
    - name: Create systemd service for observability stack
      ansible.builtin.copy:
        dest: /etc/systemd/system/observability.service
        content: |
          [Unit]
          Description=Observability Stack
          Requires=docker.service
          After=docker.service
          
          [Service]
          Type=oneshot
          RemainAfterExit=yes
          WorkingDirectory={{ install_dir }}
          ExecStart=/usr/bin/docker compose up -d
          ExecStop=/usr/bin/docker compose down
          ExecReload=/usr/bin/docker compose restart
          
          [Install]
          WantedBy=multi-user.target
        mode: '0644'
      notify: Reload systemd
    
    - name: Enable observability service
      ansible.builtin.systemd:
        name: observability
        enabled: true
        daemon_reload: true
    
    # =========================================================================
    # Copy Operational Scripts
    # =========================================================================
    
    - name: Copy backup script
      ansible.builtin.copy:
        src: "../scripts/backup.sh"
        dest: "{{ install_dir }}/backup.sh"
        mode: '0755'
    
    - name: Copy restore script
      ansible.builtin.copy:
        src: "../scripts/restore.sh"
        dest: "{{ install_dir }}/restore.sh"
        mode: '0755'
    
    - name: Copy health check script
      ansible.builtin.copy:
        src: "../scripts/health-check.sh"
        dest: "{{ install_dir }}/health-check.sh"
        mode: '0755'
    
    - name: Setup daily backup cron job
      ansible.builtin.cron:
        name: "Observability backup"
        hour: "2"
        minute: "0"
        job: "{{ install_dir }}/backup.sh >> {{ install_dir }}/logs/backup.log 2>&1"
        user: root
    
  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

# =============================================================================
# Post-deployment information
# =============================================================================

- name: Display deployment information
  hosts: observability
  gather_facts: false
  vars:
    deployment_type: "{{ deployment_type | default('single') }}"
    install_dir: /opt/observability
    grafana_admin_password: "{{ grafana_admin_password | default('admin') }}"
  tasks:
    - name: Show access information (single mode)
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "Observability Stack Deployed Successfully!"
          - "============================================"
          - ""
          - "Access URLs:"
          - "  - Grafana: http://{{ inventory_hostname }}:3000"
          - "    Username: admin"
          - "    Password: {{ grafana_admin_password }}"
          - ""
          - "OTLP Endpoints:"
          - "  - gRPC: {{ inventory_hostname }}:4317"
          - "  - HTTP: {{ inventory_hostname }}:4318"
          - ""
          - "Management Commands:"
          - "  - Status:  cd {{ install_dir }} && docker compose ps"
          - "  - Logs:    cd {{ install_dir }} && docker compose logs -f"
          - "  - Restart: systemctl restart observability"
          - "  - Stop:    systemctl stop observability"
          - "============================================"
      when: deployment_type == 'single'

    - name: Show access information (scalable mode)
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "Observability Stack Deployed Successfully!"
          - "============================================"
          - ""
          - "Access URLs:"
          - "  - Grafana:    http://{{ inventory_hostname }}:3000 (admin/{{ grafana_admin_password }})"
          - "  - Prometheus: http://{{ inventory_hostname }}:9090"
          - "  - Tempo:      http://{{ inventory_hostname }}:3200"
          - "  - Mimir:      http://{{ inventory_hostname }}:9009"
          - "  - Loki:       http://{{ inventory_hostname }}:3100"
          - "  - HAProxy:    http://{{ inventory_hostname }}:8404/stats"
          - ""
          - "OTLP Endpoints:"
          - "  - gRPC: {{ inventory_hostname }}:4317"
          - "  - HTTP: {{ inventory_hostname }}:4318"
          - ""
          - "Management Commands:"
          - "  - Status:  cd {{ install_dir }} && docker compose ps"
          - "  - Logs:    cd {{ install_dir }} && docker compose logs -f"
          - "  - Restart: systemctl restart observability"
          - "  - Stop:    systemctl stop observability"
          - "============================================"
      when: deployment_type == 'scalable'
